<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Grossesse</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <div class="chatbox">
        <div class="messages" id="messages"></div>
        <div class="input">
            <input type="text" id="userInput" placeholder="Tapez votre message...">
            <button onclick="sendMessage()">Envoyer</button>
        </div>
    </div>

    <script>
        function sendMessage() {
            const userInput = document.getElementById('userInput').value.trim();
            if (!userInput) return;
            
            const messages = document.getElementById('messages');

            // Ajouter le message de l'utilisateur
            const userDiv = document.createElement('div');
            userDiv.className = 'user-message';
            userDiv.innerHTML = `<strong>Vous:</strong> ${userInput}`;
            messages.appendChild(userDiv);

            // Afficher un indicateur de frappe
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = '<strong>Assistant:</strong> <span class="typing">R√©flexion en cours...</span>';
            messages.appendChild(typingDiv);
            messages.scrollTop = messages.scrollHeight;

            // Envoyer le message au serveur
            fetch('/chatbot/api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ message: userInput }),
            })
            .then(response => response.json())
            .then(data => {
                // Supprimer l'indicateur de frappe
                messages.removeChild(typingDiv);
                
                // Ajouter la r√©ponse du chatbot
                const botDiv = document.createElement('div');
                botDiv.className = 'bot-message';
                
                // Formater la r√©ponse avec markdown basique
                let formattedResponse = data.response
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
                
                botDiv.innerHTML = `<strong>ü§ñ Assistant Grossesse:</strong> ${formattedResponse}`;
                
                // Ajouter des classes sp√©ciales pour les urgences
                if (data.is_emergency) {
                    botDiv.className += ' emergency-message';
                }
                
                messages.appendChild(botDiv);
                document.getElementById('userInput').value = '';
                messages.scrollTop = messages.scrollHeight;
                
                // Afficher des informations de debug si disponibles
                if (data.user_profile && Object.keys(data.user_profile).length > 0) {
                    console.log('Profil utilisateur:', data.user_profile);
                }
            })
            .catch(error => {
                // Supprimer l'indicateur de frappe en cas d'erreur
                if (messages.contains(typingDiv)) {
                    messages.removeChild(typingDiv);
                }
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = '<strong>Erreur:</strong> Impossible de se connecter au serveur. Veuillez r√©essayer.';
                messages.appendChild(errorDiv);
                messages.scrollTop = messages.scrollHeight;
            });
        }
        
        // Fonction pour obtenir le token CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Permettre l'envoi avec Enter
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('userInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Message de bienvenue
            const messages = document.getElementById('messages');
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'bot-message welcome-message';
            welcomeDiv.innerHTML = `
                <strong>ü§ñ Assistant Grossesse:</strong> 
                Bonjour ! Je suis votre assistant sp√©cialis√© en grossesse. 
                Je peux r√©pondre √† toutes vos questions sur :<br>
                ‚Ä¢ Les sympt√¥mes et leur signification<br>
                ‚Ä¢ L'alimentation et la nutrition<br>
                ‚Ä¢ L'exercice physique<br>
                ‚Ä¢ Le d√©veloppement de votre b√©b√©<br>
                ‚Ä¢ La pr√©paration √† l'accouchement<br>
                ‚Ä¢ L'√©valuation de votre profil de risque<br><br>
                N'h√©sitez pas √† me poser vos questions ! üòä
            `;
            messages.appendChild(welcomeDiv);
        });
    </script>
    
    <!-- Footer avec signature -->
    <footer class="footer">
        <p>ü§∞ Assistant Grossesse IA - D√©velopp√© avec ‚ù§Ô∏è pour les futures mamans</p>
        <p><strong>üë©‚Äçüíª D√©velopp√© par : Inassona Sow</strong></p>
        <p><small>‚ö†Ô∏è Cet outil ne remplace pas l'avis m√©dical. Consultez toujours votre professionnel de sant√©.</small></p>
    </footer>
</body>
</html>